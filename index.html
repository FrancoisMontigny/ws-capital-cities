<!DOCTYPE html>
<html>
	<head>
		<title>CAPITALS SEARCH ENGINE</title>

		<!-- Nos feuilles de style -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>

		<!-- Nos srcipts js-->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<meta charset="UTF-8">
		<link rel="icon" href="images/logo.jpg" />
		<link rel="stylesheet" href="css/style.css" />
		<script src="js/autocomplete.js"></script>
		<script src="js/util.js"></script>
		<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
		<script src="js/map.js"></script>

	</head>
	<body>
			<div class="container-fluid">
				<div class="row navbar navbar-dark bg-dark">
					<a class="col navbar-brand" href="accueil.html">CAPITALS SEARCH ENGINE</a>
					<div class="col-3">
						<div id="autocomplete" class="autocomplete">
							<input id="recherche" class="form-control mdb-autocomplete" type="text" placeholder="Une capitale ou un pays" value="" />
						</div>
					</div>
					<button id="bouton_recherche" class="col-1 btn btn-success" type="submit"><i class="fas fa-search"></i></button>
				</div>
				<div class="row">
				</div>
				<div class="row jumbotron">
					<h2 class="col display-1" style="text-align: center;" id="nom"></h2>
				</div>
				<div class="row container-fluid">
					<div class="row">
						<div class="col-8">
							<p class="text-justify">
								<img class="rounded float-left" src="images/blason.svg" style="width: 250px; margin-right: 20px;" alt="blason"/>
								<span id="description"></span>
							</p>
						</div>
						<div class="col-4">
							<img class="img-thumbnail" src="" alt="Image" id="image"></img>
							<div class="container-fluid">
								<div class="row">
									<p class="col">
										Local name
									</p>
									<p class="col" id="nom-local">
									</p>
								</div>
								<div class="row">
									<p class="col">
										Country
									</p>
									<p class="col" id="pays">
									</p>
								</div>
								<div class="row">
									<p class="col">
										Continent
									</p>
									<p class="col" id="continent">
										Europe
									</p>
								</div>
								<div class="row">
									<p class="col">
										Région du pays
									</p>
									<p class="col" id="region">
										Île-de-France
									</p>
								</div>
								<div class="row">
									<p class="col">
										Demonym
									</p>
									<p class="col" id="gentille">
									</p>
								</div>
								<div class="row">
									<p class="col">
										Mayor
									</p>
									<p class="col" id="maire">
									</p>
								</div>
								<div class="row">
									<p class="col">
										Population
									</p>
									<p class="col" id="population">
									</p>
								</div>
								<div class="row">
									<p class="col">
										Density
									</p>
									<p class="col" id="densite">
										UNDEFINED
									</p>
								</div>
								<div class="row">
									<p class="col">
										Surface area
									</p>
									<p class="col" id="superficie">
									</p>
								</div>
								<div class="row">
									<p class="col">
										Altitude
									</p>
									<p class="col" id="altitude">
										100 m
									</p>
								</div>
								<div class="row">
									<p class="col">
										Altitude minimum
									</p>
									<p class="col" id="altitude-min">
										80 m
									</p>
								</div>
								<div class="row">
									<p class="col">
										Altitude maximum
									</p>
									<p class="col" id="altitude-max">
										150 m
									</p>
								</div>
								<div class="row">
									<p class="col">
										Position
									</p>
									<p class="col" id="position">
									</p>
								</div>
								<div class="row">
									<p class="col">
										Motto
									</p>
									<p class="col" id="devise">
									</p>
								</div>
								<div class="row">
									<p class="col">
										Website
									</p>
									<p class="col">
										<a id="pageWeb"></a>
									</p>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class= "col-lg-12 jumbotron">
						<div id="map" style ="height: 500px;"></div>
					</div>
				</div>
			</div>
			<div id="acteur"></div>
	</body>

	<script type="text/javascript">
		initialiseMap('map');
	</script>

	<script type="text/javascript">
		var capitals = [];
		var capitalUrls = [];
		var population;
		var surface;

		readTextFile("requetes/capitalCitiesRequest.rq", function(query) {
			var url = 'http://dbpedia.org/sparql/?default-graph-uri=http%3A%2F%2Fdbpedia.org&query='+ encodeURIComponent(query) +'&format=json';
			$.getJSON(url+"&callback=?", function(resultats) {
				resultats.results.bindings.forEach(function(element) {
					capitals.push(element.capitalName.value);
					capitalUrls.push(element.capital.value);
				});
				autocomplete(document.getElementById('recherche'), document.getElementById("autocomplete"), capitals, rechercher);

				var capital = getUrlParameter('capitalUrl');
				var index = capitalUrls.indexOf(capital);
				// console.log(capital);

				if (capital !== undefined && capital !== null && index >= 0) {
					var name = capitals[index];
					$("#nom").text(name);

					request("requetes/populationTotalRequest.rq", "#population", capital, (elem) => { 
							population = elem["popTotalInt"].value;
							computeDensity();
							return numberWithCommas(population) + " hab.";
						});

					request("requetes/popDemonymRequest.rq", "#gentille", capital, (elem) => {return capitalizeFirstLetter(elem["popDemonymString"].value);});

					request("requetes/totalAreaRequest.rq", "#superficie", capital, (elem) => {
							surface = elem["areaDouble"].value;
							computeDensity();
							return numberWithCommas(surface) + " km²";
						});

					request("requetes/coordinatesRequest.rq", "#position", capital, (elem) => {
							var coordonnees = elem.latitudeDegrees.value + "°" + elem.latitudeMinutes.value + "'" + elem.directionNS.value + " " + elem.longitudeDegrees.value + "°" + elem.longitudeMinutes.value + "'" + elem.directionEW.value;
							setViewMap(elem.latitudeDegrees.value, elem.latitudeMinutes.value, elem.directionNS.value, elem.longitudeDegrees.value, elem.longitudeMinutes.value, elem.directionEW.value);
							return coordonnees;
						});

					request("requetes/abstractRequest.rq", "#description", capital, (elem) => {return elem["callret-1"].value});

					request("requetes/countryNameRequest.rq", "#pays", capital, (elem) => {
						return elem["labelState"].value}
					);

					request("requetes/countryNameRequest.rq", "#nom-local", capital, (elem) => {
						return elem["labelCityLocal"].value}
					);

					request("requetes/leaderRequest.rq", "#maire", capital, (elem) => {
							var call2 = elem["nameString"];
							if (call2 !== undefined && call2 !== null) {
								return call2.value;
							} else {
								return elem["leaderNameString"].value;
							}
						});

					request("requetes/mottoRequest.rq", "#devise", capital, (elem) => {return elem["callret-1"].value});

					requestImage("requetes/imageRequest.rq", "#image", capital, (elem) => {return elem["image"].value});

					requestLink("requetes/pageRequest.rq", "#pageWeb", capital, (elem) => {return elem["page"].value})

				}
			});
		});

		function request(filename, fieldId, capital, format) {
			// console.log("request");
			// console.log(filename);
			readTextFile(filename, function(req) {
				req = req.replace('%CAPITAL_URL%', '"' + capital + '"');
				// console.log(req);
				var reqUrl = 'http://dbpedia.org/sparql/?default-graph-uri=http%3A%2F%2Fdbpedia.org&query='+ encodeURIComponent(req) +'&format=json';
				$.getJSON(reqUrl+"&callback=?", function(resultatsReq) {
					// console.log(resultatsReq);
					var first = result = resultatsReq.results.bindings[0];
					if (first !== undefined && first !== null) {
						var result = format(first);
						// console.log(result);
						$(fieldId).text(result);
					} else {
						$(fieldId).text("UNDEFINED");
					}
				});
			});
		}

		function requestLink(filename, fieldId, capital, format) {
			// console.log("request");
			// console.log(filename);
			readTextFile(filename, function(req) {
				req = req.replace('%CAPITAL_URL%', '"' + capital + '"');
				// console.log(req);
				var reqUrl = 'http://dbpedia.org/sparql/?default-graph-uri=http%3A%2F%2Fdbpedia.org&query='+ encodeURIComponent(req) +'&format=json';
				$.getJSON(reqUrl+"&callback=?", function(resultatsReq) {
					// console.log(resultatsReq);
					var first = result = resultatsReq.results.bindings[0];
					if (first !== undefined && first !== null) {
						var result = format(first);
						// console.log(result);
						$(fieldId).attr("href", result);
						$(fieldId).text(result);
					} else {
						$(fieldId).text("UNDEFINED");
					}
				});
			});
		}

		function requestImage(filename, fieldId, capital, format) {
			// console.log("request");
			readTextFile(filename, function(req) {
				req = req.replace('%CAPITAL_URL%', '"' + capital + '"');
				// console.log(req);
				var reqUrl = 'http://dbpedia.org/sparql/?default-graph-uri=http%3A%2F%2Fdbpedia.org&query='+ encodeURIComponent(req) +'&format=json';
				$.getJSON(reqUrl+"&callback=?", function(resultatsReq) {
					// console.log(resultatsReq);
					var first = result = resultatsReq.results.bindings[0];
					if (first !== undefined && first !== null) {
						var result = format(first);
						// console.log(result);
						$(fieldId).attr("src", result);
					} else {
						$(fieldId).attr("alt", "UNDEFINED");
					}
				});
			});
		}

		function computeDensity() {
			if (surface !== undefined && surface !== null && population !== undefined && population !== null) {
				var density = population / surface;
				var formatted = numberWithCommas(parseFloat(density).toFixed(2)) + " hab./km²";
				$("#densite").text(formatted);
			}
		}

		$('#bouton_recherche').click(rechercher);

		function rechercher() {
			var url = window.location.href.split('?')[0];
			var capital = $('#recherche').val();
			var index = capitals.indexOf(capital);
			var capitalUrl = capitalUrls[index];

			var newUrl = url + '?capitalUrl=' + capitalUrl;
			window.location = newUrl;
		};

	</script>
</html>