<!DOCTYPE html>
<html>
	<head>
		<title>CAPITALS SEARCH ENGINE</title>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<meta charset="UTF-8">
		<link rel="stylesheet" href="css/style.css" />
		<script src="js/autocomplete.js"></script>
		<script src="js/util.js"></script>
	</head>
	<body>
			<div class="container-fluid">
				<div class="row navbar navbar-dark bg-dark">
					<h1 class="col navbar-brand">CAPITALS SEARCH ENGINE</h1>
					<div class="col-3">
						<div id="autocomplete" class="autocomplete">
							<input id="recherche" class="form-control mdb-autocomplete" type="text" placeholder="Une capitale ou un pays" value="" />
						</div>
					</div>
					<button id="bouton_recherche" class="col-1 btn btn-success" type="submit"><i class="fas fa-search"></i></button>
				</div>
				<div class="row">
				</div>
				<div class="row jumbotron">
					<h2 class="col display-1" style="text-align: center;" id="nom">Paris</h2>
				</div>
				<div class="row container-fluid">
					<div class="row">
						<div class="col-8">
							<p class="text-justify">
								<img class="rounded float-left" src="images/blason.svg" style="width: 250px; margin-right: 20px;" alt="blason"/>
								<span id="description"></span>
							</p>
						</div>
						<div class="col-4">
							<img class="img-thumbnail" src="images/paris.jpg" alt="image de paris"></img>
							<div class="container-fluid">
								<div class="row">
									<p class="col">
										Nom local
									</p>
									<p class="col" id="nom-local">
										Paris (fr)
									</p>
								</div>
								<div class="row">
									<p class="col">
										Country
									</p>
									<p class="col" id="pays">
									</p>
								</div>
								<div class="row">
									<p class="col">
										Continent
									</p>
									<p class="col" id="continent">
										Europe
									</p>
								</div>
								<div class="row">
									<p class="col">
										Région du pays
									</p>
									<p class="col" id="region">
										Île-de-France
									</p>
								</div>
								<div class="row">
									<p class="col">
										Demonym
									</p>
									<p class="col" id="gentille">
									</p>
								</div>
								<div class="row">
									<p class="col">
										Maire
									</p>
									<p class="col" id="maire">
										Anne Hidalgo
									</p>
								</div>
								<div class="row">
									<p class="col">
										Population
									</p>
									<p class="col" id="population">
									</p>
								</div>
								<div class="row">
									<p class="col">
										Densité
									</p>
									<p class="col" id="densite">
										100 000 hab./km²
									</p>
								</div>
								<div class="row">
									<p class="col">
										Superficie
									</p>
									<p class="col" id="superficie">
										100 km²
									</p>
								</div>
								<div class="row">
									<p class="col">
										Altitude
									</p>
									<p class="col" id="altitude">
										100 m
									</p>
								</div>
								<div class="row">
									<p class="col">
										Altitude minimum
									</p>
									<p class="col" id="altitude-min">
										80 m
									</p>
								</div>
								<div class="row">
									<p class="col">
										Altitude maximum
									</p>
									<p class="col" id="altitude-max">
										150 m
									</p>
								</div>
								<div class="row">
									<p class="col">
										Position
									</p>
									<p class="col" id="position">
									</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div id="acteur"></div>
	</body>
	<script type="text/javascript">
		var capitals = [];
		var capitalUrls = [];

		readTextFile("capitalCitiesRequest.rq", function(query) {
			var url = 'http://dbpedia.org/sparql/?default-graph-uri=http%3A%2F%2Fdbpedia.org&query='+ encodeURIComponent(query) +'&format=json';
			$.getJSON(url+"&callback=?", function(resultats) {
				resultats.results.bindings.forEach(function(element) {
					capitals.push(element.capitalName.value);
					capitalUrls.push(element.capital.value);
				});
				autocomplete(document.getElementById('recherche'), document.getElementById("autocomplete"), capitals, rechercher);

				var capital = getUrlParameter('capitalUrl');
				console.log(capital);

				if (capital !== undefined && capital !== null && capitalUrls.indexOf(capital) >= 0) {
					request("populationTotalRequest.rq", "#population", capital, (elem) => { return numberWithCommas(elem["callret-1"].value) + " hab.";});
					request("popDemonymRequest.rq", "#gentille", capital, (elem) => {return elem["popDemonymString"].value;});
					request("totalAreaRequest.rq", "#superficie", capital, (elem) => {return numberWithCommas(elem["callret-1"].value) + " km²";});
					request("coordinatesRequest.rq", "#position", capital, (elem) => {return elem.latitudeDegrees.value + "°" + elem.latitudeMinutes.value + "'" + elem["callret-3"].value + " " + elem.longitudeDegrees.value + "°" + elem.longitudeMinutes.value + "'" + elem["callret-6"].value;});
					request("abstractRequest.rq", "#description", capital, (elem) => {return elem["callret-1"].value});
					request("countryNameRequest.rq", "#pays", capital, (elem) => {return elem["labelS"].value});
				}
			});
		});

		function request(filename, fieldId, capital, format) {
			console.log("request");
			console.log(filename);
			readTextFile(filename, function(req) {
				req = req.replace('%CAPITAL_URL%', '"' + capital + '"');
				console.log(req);
				var reqUrl = 'http://dbpedia.org/sparql/?default-graph-uri=http%3A%2F%2Fdbpedia.org&query='+ encodeURIComponent(req) +'&format=json';
				$.getJSON(reqUrl+"&callback=?", function(resultatsReq) {
					console.log(resultatsReq);
					var first = result = resultatsReq.results.bindings[0];
					if (first !== undefined && first !== null) {
						var result = format(first);
						console.log(result);
						$(fieldId).text(result);
					} else {
						$(fieldId).text("UNDEFINED");
					}
				});
			});
		}

		$('#bouton_recherche').click(rechercher);

		function rechercher() {
			var url = window.location.href.split('?')[0];
			var capital = $('#recherche').val();
			var index = capitals.indexOf(capital);
			var capitalUrl = capitalUrls[index];

			var newUrl = url + '?capitalUrl=' + capitalUrl;
			window.location = newUrl;
		};

	</script>
</html>